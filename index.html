<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G-code Visualizer & Catalog</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #121212;
      color: white;
    }
    h1, h2 {
      text-align: center;
    }
    .upload-section {
      text-align: center;
      margin-bottom: 20px;
    }
    canvas {
      border: 1px solid #444;
      background: #000;
      display: block;
      margin: 10px auto;
    }
    .print-entry {
      background: #1e1e1e;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 8px;
      margin: 10px 0;
    }
    button {
      background: #333;
      color: white;
      border: none;
      padding: 6px 10px;
      margin-top: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>G-code Visualizer</h1>
  <div class="upload-section">
    <input type="file" id="gcodeInput" accept=".gcode" />
  </div>
  <canvas id="gcodeCanvas" width="400" height="400"></canvas>
  <div id="printCatalog"></div>

  <script>
    const input = document.getElementById("gcodeInput");
    const canvas = document.getElementById("gcodeCanvas");
    const ctx = canvas.getContext("2d");
    const catalog = document.getElementById("printCatalog");

    function drawGCode(content) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "#00ff00";
      ctx.lineWidth = 0.5;

      const lines = content.split("\\n");
      let x = 0, y = 0;
      const scale = 2; // Adjust scale as needed

      ctx.beginPath();
      for (const line of lines) {
        if (line.startsWith(";") || line.length < 2) continue;

        const xMatch = line.match(/X([-\\d\\.]+)/);
        const yMatch = line.match(/Y([-\\d\\.]+)/);

        const newX = xMatch ? parseFloat(xMatch[1]) * scale : x;
        const newY = yMatch ? parseFloat(yMatch[1]) * scale : y;

        ctx.moveTo(x, canvas.height - y);
        ctx.lineTo(newX, canvas.height - newY);

        x = newX;
        y = newY;
      }
      ctx.stroke();
    }

    function saveToCatalog(name) {
      const existing = JSON.parse(localStorage.getItem("gcodeCatalog") || "[]");
      existing.push({ name, date: new Date().toISOString() });
      localStorage.setItem("gcodeCatalog", JSON.stringify(existing));
      loadCatalog();
    }

    function loadCatalog() {
      catalog.innerHTML = "<h2>Your Print Catalog</h2>";
      const entries = JSON.parse(localStorage.getItem("gcodeCatalog") || "[]");
      if (!entries.length) {
        catalog.innerHTML += "<p>No G-code files uploaded yet.</p>";
        return;
      }
      entries.reverse().forEach((entry, i) => {
        const div = document.createElement("div");
        div.className = "print-entry";
        div.innerHTML = `
          <strong>Name:</strong> ${entry.name}<br/>
          <strong>Uploaded:</strong> ${new Date(entry.date).toLocaleString()}<br/>
          <button onclick="deleteEntry(${entries.length - 1 - i})">Delete</button>
        `;
        catalog.appendChild(div);
      });
    }

    function deleteEntry(index) {
      const entries = JSON.parse(localStorage.getItem("gcodeCatalog") || "[]");
      entries.splice(index, 1);
      localStorage.setItem("gcodeCatalog", JSON.stringify(entries));
      loadCatalog();
    }

    input.addEventListener("change", () => {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const content = reader.result;
        drawGCode(content);
        saveToCatalog(file.name);
      };
      reader.readAsText(file);
    });

    loadCatalog();
  </script>
</body>
</html>
